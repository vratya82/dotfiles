import qualified XMonad.StackSet as W
import XMonad
import System.Exit (exitWith, ExitCode(ExitSuccess))
import System.IO (hPutStrLn)

-- Hooks
import XMonad.Hooks.DynamicLog
import XMonad.Hooks.ManageDocks
import XMonad.Hooks.SetWMName
import XMonad.Hooks.EwmhDesktops (ewmh, ewmhFullscreen)

-- Utils
import XMonad.Util.Run (spawnPipe)
import XMonad.Util.SpawnOnce
import XMonad.Util.EZConfig (additionalKeys)

-- Layouts
import XMonad.Layout.Spacing
import XMonad.Layout.Gaps
import XMonad.Layout.NoBorders
import XMonad.Layout.Grid
import XMonad.Layout.PerWorkspace (onWorkspace)

-- Terminal & Modifier
theTerminal :: String
theTerminal = "alacritty"

modKey :: KeyMask
modKey = mod4Mask -- Super/Windows key

-- Workspaces with Greek numeric names
myWorkspaces :: [String]
myWorkspaces =
  [ "ἓν"      -- Hen (1)
  , "δύο"     -- Dyo (2)
  , "τρεῖς"   -- Treis (3)
  , "τέτταρες"-- Tettares (4)
  , "πέντε"   -- Pente (5)
  , "ἕξ"      -- Hex (6)
  , "ἑπτά"    -- Hepta (7)
  , "ὀκτώ"    -- Okto (8)
  , "ἐννέα"   -- Ennea (9)
  ]

-- Layouts with per-workspace logic
theLayout = avoidStruts $
  gaps [(U,8), (D,8), (L,8), (R,8)] $
  spacing 8 $
  onWorkspace "θ" (noBorders Full) $
  Grid ||| tiled ||| Mirror tiled ||| noBorders Full
  where
    tiled = Tall 1 (3/100) (1/2)

-- Startup applications and session config
myStartup :: X ()
myStartup = do
  spawnOnce "picom &"
  spawnOnce "xscreensaver -nosplash &"
  spawnOnce "~/scripts/random_wal.py"
  setWMName "LG3D"

-- Main config
main :: IO ()
main = do
  xmproc <- spawnPipe "xmobar ~/.xmonad/xmobar/.xmobarrc"
  xmonad $ ewmhFullscreen . ewmh $ docks def
    { modMask = modKey
    , terminal = theTerminal
    , layoutHook = theLayout
    , borderWidth = 2
    , normalBorderColor  = "#44475a"
    , focusedBorderColor = "#a6adc8"
    , startupHook = myStartup
    , workspaces = myWorkspaces
    , focusFollowsMouse = False
    , clickJustFocuses = False
    , logHook = dynamicLogWithPP xmobarPP
        { ppOutput = hPutStrLn xmproc
        , ppTitle = xmobarColor "#a6e3a1" "" . shorten 60
        , ppCurrent = xmobarColor "#89b4fa" "" . wrap "[" "]"
        , ppVisible = wrap "<" ">"
        , ppLayout = xmobarColor "#f38ba8" ""
        , ppSep = " | "
        , ppOrder = \[ws, l, t] -> [ws, l, t]
        }
    }
    `additionalKeys`
    [ ((modKey, xK_Return), spawn theTerminal)
    , ((modKey .|. shiftMask, xK_c), kill)
    , ((modKey .|. mod1Mask, xK_q), io (exitWith ExitSuccess))
    , ((modKey, xK_r), spawn "rofi -show run")
    , ((modKey .|. shiftMask, xK_r), spawn "xmonad --recompile && xmonad --restart")
    , ((modKey .|. shiftMask, xK_t), withFocused $ windows . W.sink)
    , ((modKey, xK_f), withFocused (\w -> windows (W.float w (W.RationalRect 0 0 1 1))))
    , ((modKey, xK_F1), spawn "firefox")
    , ((modKey, xK_F2), spawn "thunderbird")
    , ((modKey, xK_F3), spawn "thunar")
    , ((modKey, xK_F4), spawn "discord")
    , ((modKey, xK_F5), spawn "virt-manager")
    , ((modKey, xK_F6), spawn (theTerminal ++ " -e yazi"))
    , ((modKey, xK_F7), spawn (theTerminal ++ " -e nvim"))
    , ((modKey, xK_F8), spawn (theTerminal ++ " -e ranger"))
    , ((modKey, xK_F9), spawn (theTerminal ++ " -e bmon"))
    , ((modKey, xK_F10), spawn (theTerminal ++ " -e htop"))
    , ((modKey, xK_F11), spawn "syncthing")
    , ((modKey, xK_F12), spawn "xscreensaver-command -lock")
    ]

